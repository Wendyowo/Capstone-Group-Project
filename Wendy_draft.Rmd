---
title: "Wendy_Draft"
author: "Wendy Xu"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(sqldf)
library(ggplot2)
library(readr)
library(maps)
library(dplyr)
```

```{r data preprocessing}
df <- read.csv("Spot Data.csv")
#delete duplicated rows
spot_df <- unique(df)
names(spot_df) <- c('Patient_ID','Patient_Zip','Patient_Age','Patient_Sex','Type_of_Kit',"Specimen_Type","Client_ID",	"Datetime_Kit_Delivered","Datetime_Kit_Registered","Datetime_Sample_Sent_In","Datetime_Sample_Received","Datetime_of_End_Status","End_Status","Rejection_Reason")

#
a <- sqldf("
SELECT s1.Patient_ID, s1.Type_of_Kit, s1.End_Status,
FROM spot_df s1
INNER JOIN spot_df s2 on s1.Patient_ID = s2.Patient_ID
WHERE s1.Patient_ID = s2.Patient_ID AND s1.Type_of_Kit = s2.Type_of_Kit
      ")

```

```{r handle type of kit}
#handle 
spot_df_new$Type_of_Kit <- as.factor(spot_df_new$Type_of_Kit) 
levels(spot_df_new$Type_of_Kit) <- c("1", "2", "3","4","5", "6", "7","8","9", "10", "11","12","13", "14", "15","16",
                                     "17", "18", "19","20","21", "22", "23","24","25", "26", "27","28",
                                      "29","30","31", "32", "33","34","35", "36", "37","38","39","40","41",
                                     "42","43","44","45", "46","47","48")
```

```{r}
# only keep rows with end_status are rejected, resulted and partially_resulted (for analyzing purpose)
spot_df_new <- subset(spot_df, End_Status == "rejected" | End_Status == "resulted" | End_Status == "partially_resulted")

```


```{r}
# convert end status variable into dummy
spot_df_new$End_Status <- ifelse(spot_df_new$End_Status == "resulted", 1, 0)

```

```{r geological visualization}
#link back to https://simplemaps.com/data/us-zips
zip_region_map <- read_csv("uszips.csv")
zip_data <- as.data.frame(spot_df$Patient_Zip)
names(zip_data) <- "zip"
us_map <- map_data("state")

zip_data_region <- zip_data %>%
  left_join(zip_region_map, by = "zip")

colnames(zip_data_region)[which(colnames(zip_data_region) == "state_name")] <- "region"

us_map_region <- zip_data_region %>%
  left_join(us_map , by = c("region" = "region"))

ggplot(us_map_region, aes(x = lng, y = lat.x)) +
  geom_point(aes(color = region), size = 1) +
  geom_polygon(data = us_map, aes(x = long, y = lat, group = group), fill = NA, color = "black") +
  coord_map() +
  labs(title = "Zip Code Locations on US Map")+
  
  theme(legend.position = "none")
```

```{r Type of kit attempt}
type_of_kit <- sqldf("
SELECT s1.Type_of_Kit, COUNT(s1.Type_of_Kit) AS COUNT
FROM spot_df s1
GROUP BY s1.Type_of_Kit
ORDER BY COUNT(s1.Type_of_Kit) DESC
      ")
type_of_kit_rejected <- sqldf("
SELECT s1.Type_of_Kit, COUNT(s1.Type_of_Kit) AS COUNT, s1.End_Status
FROM spot_df_new s1
WHERE s1.End_Status = 0
GROUP BY s1.Type_of_Kit, s1.End_Status
ORDER BY COUNT(s1.Type_of_Kit) DESC
      ")

Total_Rejected <- sqldf("
SELECT SUM(s2.COUNT)
FROM type_of_kit_rejected s2
      ")
type_of_kit_rejected_percentage <- mutate(type_of_kit_rejected,percentage = COUNT/1024)

type_of_kit_resulted <- sqldf("
SELECT s1.Type_of_Kit, COUNT(s1.Type_of_Kit) AS COUNT, s1.End_Status
FROM spot_df_new s1
WHERE s1.End_Status = 1
GROUP BY s1.Type_of_Kit, s1.End_Status
ORDER BY COUNT(s1.Type_of_Kit) DESC
      ")
Total_Resulted <- sqldf("
SELECT SUM(s2.COUNT)
FROM type_of_kit_resulted s2
      ")
type_of_kit_resulted_percentage <- mutate(type_of_kit_resulted,percentage = COUNT/8683)
Total_Resulted <- rbind(type_of_kit_resulted_percentage, type_of_kit_rejected_percentage)
Total_Resulted <- Total_Resulted[order(-Total_Resulted$COUNT), ]

#Visualization

a <- ggplot(Total_Resulted, aes(x = reorder(End_Status,Type_of_Kit), y = percentage, fill = End_Status)) +geom_col(position = "identity") 

a
```

